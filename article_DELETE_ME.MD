## Todo
- use models instead of plain datatypes
- review https://github.com/speakeasy-api/speakeasy
- https://github.com/goadesign/goa/issues/3390
  - Include link to - https://invite.slack.golangbridge.org/
  - Register for the group at https://invite.slack.golangbridge.org/.
  - Log in at https://gophers.slack.com/.
  - add pull request to getting started article.

# The article

## Introduction
write go code in goa -> goa.design makes openapi spec, goa.example makes code stubs you complete to actually make the backend do stuff -> put openapi spec in speakeasy -> generates sdks in all languages

## Prerequisites
Docker, version 20 or greater.

Speakeasy is an online-only service. Please register before continuing this tutorial: https://app.speakeasyapi.dev. Once you've registered, create a workspace with named `club`. Browse to API keys. Click `New Api Key`. Name it `club`. Copy and save the key content to use later.

## Goa

### Introduction

### Get help
Use the Go Slack group to ask for help with Goa.
- Register for the group at https://invite.slack.golangbridge.org/.
- Log in at https://gophers.slack.com/.
- Join the Goa channel to ask questions on the framework.

### Other Go web frameworks

### Other Go API frameworks
- https://stackoverflow.com/questions/66171424/how-to-generate-openapi-v3-specification-from-go-source-code
- https://github.com/swaggest/rest/
- https://github.com/deepmap/oapi-codegen
- https://github.com/ogen-go/ogen
- https://github.com/swaggest/openapi-go

## Customising the schema
- How can you customize the OpenAPI spec generated by Goa?
- What kind of customizations lead to better SDK generations

- operationId for each path.
- Use $ref instead of inline schemas for input/output.
- Speakeasy-specific OpenAPI extensions, for example, retries.
- Tags to organize code in the generated SDKs.

## Tsoa

## Create the API specification in Goa

```bash
cd ~/code/speakeasy-goa-example;
mkdir app;
docker stop gobox; docker rm gobox;
docker run --name gobox -v ./app:/go/src/app -it golang:1.21.2 bash;
cd src/app;
go mod init app;
go install goa.design/goa/v3/cmd/goa@v3;
go install google.golang.org/protobuf/cmd/protoc-gen-go@latest;
go install google.golang.org/grpc/cmd/protoc-gen-go-grpc@latest;

# download https://github.com/protocolbuffers/protobuf/releases/download/v24.4/protoc-24.4-linux-x86_64.zip from https://github.com/protocolbuffers/protobuf/releases
# unzip and paste bin/protoc exe file into ./app/lib
export PATH=$PATH:/go/src/app/lib # can't use relative path here
```

On subsequent runs, you can start the container instead of rebuilding it:

```bash
docker start gobox; docker exec -it gobox bash;
```

Write the API specification in `app/design/design.go`.

```bash
goa gen app/design;
goa example app/design;
```

In your host machine terminal, not in the container terminal, give yourself permissions to edit the created files. Rerun this whenever you create a file in the container.

```bash
sudo chown -R 1000:1000 ./app;
```

In `order.go` set: `return "A nice cup of tea", nil`

Compile it in the container.
```bash
go get app/cmd/club; # download dependencies
go build ./cmd/club && go build ./cmd/club-cli;
```

Since Go compiles to executables, you can now run the Club server in your physical machine.
```bash
./club
```

In another terminal
```bash
./club-cli --help
./club-cli order tea --body '{"includeMilk": false, "isGreen": false, "numberSugars": 1 }' # A nice cup of tea
 ./club-cli band play --body '{"style": "Bebop" }' # No response
```

## Create the API with Speakeasy

Speakeasy supports these languages: [C#, Go, Java, PHP, Python, Ruby, Swift, Typescript](https://www.speakeasyapi.dev/docs/create-client-sdks#language-support).

## Set up the Speakeasy CLI
The CLI is the simplest way to use Speakeasy. You can install it directly by following the instructions in the [readme](https://github.com/speakeasy-api/speakeasy). This tutorial uses the CLI from Docker to make all instructions as reproducible as possible.

```bash
docker stop speakbox; docker rm speakbox;
docker run --name speakbox -v ./app:/app -it alpine:3.18.4 sh; # docker run --name speakbox -v ./app:/app -it ubuntu:22.04 bash;
apk add curl unzip sudo; # apt update; apt install curl unzip sudo -y;
curl -fsSL https://raw.githubusercontent.com/speakeasy-api/speakeasy/main/install.sh | sh;
```

Now Speakeasy installed. Test it by running:

```bash
speakeasy help;
```

Now add you API key that you saved earlier when registering with Speakeasy.
```
export SPEAKEASY_API_KEY=your_api_key_here
```

<Aside>
If you exit the container and want to return to it later, run:
```bash
docker start speakbox; docker exec -it speakbox sh;
```
</Aside>

## Build an SDK
You now have `app/gen/http/openapi3.yaml` and Speakeasy. So you can build the SDK. In the speakbox container you started in the last section, run:

```bash
speakeasy generate sdk \
    --schema /app/gen/http/openapi3.yaml \
    --lang typescript \
    --out /app/sdk
```

Remember to give yourself permissions to the files on your host machine again.

```bash
sudo chown -R 1000:1000 ./app;
```

validate your schema



### Retries
https://www.speakeasyapi.dev/docs/customize-sdks/retries

